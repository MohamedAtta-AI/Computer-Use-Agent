FROM python:3.11-slim

# Install system dependencies including VNC and noVNC
RUN apt-get update && \
    apt-get install -y \
    xvfb \
    x11vnc \
    xterm \
    xdotool \
    scrot \
    imagemagick \
    sudo \
    mutter \
    git \
    curl \
    net-tools \
    netcat \
    software-properties-common \
    libreoffice \
    firefox-esr \
    x11-apps \
    xpdf \
    gedit \
    xpaint \
    tint2 \
    galculator \
    pcmanfm \
    unzip && \
    apt-get clean

# Install noVNC (same as original computer-use-demo)
RUN git clone --branch v1.5.0 https://github.com/novnc/noVNC.git /opt/noVNC && \
    git clone --branch v0.12.0 https://github.com/novnc/websockify /opt/noVNC/utils/websockify && \
    ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# Set up display environment
ENV DISPLAY=:1
ENV DISPLAY_NUM=1
ENV HEIGHT=768
ENV WIDTH=1024

# Create startup scripts
COPY vnc_startup.sh /opt/vnc_startup.sh
COPY novnc_startup.sh /opt/novnc_startup.sh
RUN chmod +x /opt/vnc_startup.sh /opt/novnc_startup.sh

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Expose ports
EXPOSE 8000 5900 6080

# Start VNC services and then the FastAPI app
CMD ["/bin/bash", "-c", "/opt/vnc_startup.sh && /opt/novnc_startup.sh && python run.py"] 